{% extends 'base.html' %}

{% block title %}Panel de Atención{% endblock %}

{% block body_class %}form-body{% endblock %}

{% block content %}
<div class="panel-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-message-panel {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    {% include '_logged_in_header.html' %}
    <div class="panel-main">
        <div class="call-section">
            {% if ticket_en_atencion %}
                <h4>Atendiendo a:</h4>
                <h2 class="ticket-atendido">{{ ticket_en_atencion.numero_ticket }}</h2>
        
                <div class="action-buttons">
                    <form action="{{ url_for('rellamar_ticket') }}" method="post">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="ticket_id" value="{{ ticket_en_atencion.id }}">
                        <button type="submit" class="btn-rellamar">Volver a Llamar</button>
                    </form>

                    <form action="{{ url_for('finalizar_atencion') }}" method="post">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="ticket_id" value="{{ ticket_en_atencion.id }}">
                        <button type="submit" class="btn-finalizar">Finalizar Atención</button>
                    </form>
                </div>

            {% else %}
                <h4>Llamar al siguiente turno para:</h4>
                <h2>{{ current_user.modulo_asignado }}</h2>
                <form action="{{ url_for('llamar_siguiente') }}" method="post">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn-llamar">Llamar Siguiente</button>
                </form>
            {% endif %}
        </div>

        <div class="queue-section">
            <h4>Personas en espera:</h4>
            <ul class="waiting-list">
                {% for ticket in tickets_en_espera %}
                <li>
                    <span class="ticket-name">{{ ticket.numero_ticket }}</span>
                    <span class="ticket-time" data-isodate="{{ ticket.hora_registro.isoformat() }}"></span>
                </li>
                {% else %}
                <li class="no-tickets">No hay nadie en espera.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function() {
        function formatTime(isoString) {
            if (!isoString) return '';
            // Usamos el locale 'es-CL' para asegurar el formato de 24 horas si el navegador no lo tiene por defecto
            return new Date(isoString).toLocaleTimeString('es-CL', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // Formatear las horas de los tickets que ya están en la lista al cargar la página
        document.querySelectorAll('.ticket-time[data-isodate]').forEach(function(span) {
            span.textContent = formatTime(span.dataset.isodate);
        });

        var moduloAsignado = "{{ current_user.modulo_asignado }}";
        var socket = io();

        socket.on('connect', function() {
            socket.emit('join', {room: moduloAsignado});
            console.log('Unido a la sala del módulo:', moduloAsignado);
        });

        socket.on('nuevo_ticket_registrado', function(data) {
            console.log('Nuevo ticket recibido para este módulo:', data);
            var ul = document.querySelector('.waiting-list');
            var noTickets = ul.querySelector('.no-tickets');
            if (noTickets) {
                ul.removeChild(noTickets);
            }
            var li = document.createElement('li');
            var spanName = document.createElement('span');
            spanName.className = 'ticket-name';
            spanName.textContent = data.numero_ticket;
            var spanTime = document.createElement('span');
            spanTime.className = 'ticket-time';
            // Formateamos la hora del nuevo ticket que llega por socket
            spanTime.textContent = formatTime(data.hora_registro);
            li.appendChild(spanName);
            li.appendChild(spanTime);
            ul.appendChild(li);
        });
    });
</script>
{% endblock %}