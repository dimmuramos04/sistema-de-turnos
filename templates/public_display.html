{% extends 'base.html' %}

{% block title %}Pantalla de Turnos - ULS{% endblock %}

{% block head %}{% endblock %}

{% block body_class %}public-display-body{% endblock %}

{% block content %}
<script>
    // Oculta el overlay ANTES de renderizar si ya está iniciado
    if (window.localStorage.getItem('pantallaTurnosIniciada')) {
        document.write('<style>#start-overlay{display:none;}</style>');
    }
</script>
    <div id="start-overlay">
        <div class="start-box">
            <h1>Sistema de Turnos</h1>
            <p>Haga clic en cualquier lugar para iniciar</p>
        </div>
    </div>
    
    <header class="main-header">
        <img src="{{ url_for('static', filename='images/logo_uls_blanco.png') }}" alt="Logo Adicional" class="logo">
        <img src="{{ url_for('static', filename='images/logo_adicional.png') }}" alt="Logo ULS" class="logo">
    </header>

    <div class="info-bar">
        <div id="reloj" class="clock">Cargando...</div>
        <div class="marquee">
            <span>¡Bienvenido a la Universidad de La Serena! Por favor, mantente atento a la pantalla.</span>
        </div>
    </div>

    <main class="kiosk-container">
        <div class="call-panel-container">
            {% for llamado in llamados %}
            <section class="call-panel" data-ticket-id="{{ llamado.id }}">
                <div class="call-header fade-in">
                    {{ llamado.servicio.nombre_modulo }}
                </div>
                <div class="call-body">
                    <div class="vip-badge" style="display: none;">
                        Atención Preferencial
                    </div>
                    <div class="ticket-number fade-in" style="--ticket-color: {{ llamado.servicio.color_hex }}">
                        {{ llamado.numero_ticket.split('-')[1] }}
                    </div>
                    <div class="module-number fade-in" style="--ticket-color: {{ llamado.servicio.color_hex }}">
                        {{ llamado.numero_meson }}
                    </div>
                </div>
            </section>
            {% endfor %}
            
            {# Rellenar con paneles vacíos si hay menos de 2 llamados #}
            {% for i in range(llamados|length, 2) %}
            <section class="call-panel is-empty" data-ticket-id="">
                <div class="call-header fade-in">
                    SISTEMA DE TURNOS
                </div>
                    <div class="call-body">
                        <div class="vip-badge" style="display: none;">
                        Atención Preferencial
                    </div>
                    <div class="ticket-number fade-in" style="--ticket-color: #333">
                        ----
                    </div>
                    <div class="module-number fade-in" style="--ticket-color: #333">
                        -
                    </div>
                </div>
            </section>
            {% endfor %}
        </div>

        <section class="history">
            <div class="history-header">Últimos Llamados</div>
            <ul class="history-list">
                {% for ticket in historial %}
                <li class="fade-in">
                    <span class="history-ticket" style="--ticket-color: {{ ticket.servicio.color_hex }}">{{ ticket.numero_ticket.split('-')[1] }}</span>
                    <span class="history-service">{{ ticket.modulo_solicitado }}</span>
                    <span class="history-module">Módulo {{ ticket.numero_meson }}</span>
                </li>
                {% else %}
                <li class="no-history fade-in"><span>No hay llamados recientes.</span></li>
                {% endfor %}
            </ul>
        </section>
    </main>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', (event) => {
        const overlay = document.getElementById('start-overlay');
        const audio = new Audio("{{ url_for('static', filename='sounds/alerta.mp3') }}");
        let callPanels = Array.from(document.querySelectorAll('.call-panel-container .call-panel'));

        // --- LÓGICA DEL RELOJ (sin cambios) ---
        function actualizarReloj() {
            const relojEl = document.getElementById('reloj');
            if (relojEl) {
                const ahora = new Date();
                const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const fecha = ahora.toLocaleDateString('es-CL', opcionesFecha);
                const hora = ahora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                const fechaFormateada = fecha.charAt(0).toUpperCase() + fecha.slice(1);
                relojEl.textContent = `${fechaFormateada} | ${hora}`;
            }
        }
        actualizarReloj(); 
        setInterval(actualizarReloj, 1000);

        // --- LÓGICA DE PANTALLA DE BIENVENIDA (sin cambios) ---
        // Definimos la función de desbloqueo para poder reutilizarla si el audio falla después
        const desbloquearAudio = () => {
            overlay.style.display = 'none';
            audio.play().then(() => {
                audio.pause();
                audio.currentTime = 0;
            }).catch(e => {});
            localStorage.setItem('pantallaTurnosIniciada', 'true');
            console.log("Sistema de audio activado por el usuario.");
        };

        // Siempre agregamos el listener, por si el overlay vuelve a aparecer por error de audio
        overlay.addEventListener('click', desbloquearAudio);

        if (localStorage.getItem('pantallaTurnosIniciada')) {
            overlay.style.display = 'none';
        }

        // --- LÓGICA DE CONEXIÓN EN TIEMPO REAL ---
        var socket = io();
        var esPrimeraConexion = true;

        socket.on('connect', function() {
            console.log('EVENTO: ¡Conexión exitosa al servidor!');
            socket.emit('join', {room: 'pantalla_publica'});
            
            if (!esPrimeraConexion) {
                console.log('Reconexión detectada. Recargando para sincronizar datos...');
                window.location.reload();
            }
            esPrimeraConexion = false;
        });
        socket.on('connect_error', (err) => {
            console.error('EVENTO: ¡Error de conexión!', err);
        });

        // --- LÓGICA PARA ACTUALIZAR UN PANEL ESPECÍFICO ---
        function updatePanel(panel, data) {
            panel.classList.remove('is-empty');
            panel.dataset.ticketId = data.id_ticket;

            const callHeaderEl = panel.querySelector('.call-header');
            callHeaderEl.innerText = data.nombre_modulo;

            const ticketNumberEl = panel.querySelector('.ticket-number');
            ticketNumberEl.innerText = data.numero_ticket.split('-')[1];
            ticketNumberEl.style.setProperty('--ticket-color', data.color_hex);

            const moduleNumberEl = panel.querySelector('.module-number');
            moduleNumberEl.innerText = data.numero_meson;
            moduleNumberEl.style.setProperty('--ticket-color', data.color_hex);

            // --- NUEVA LÓGICA VIP ---
            // Buscamos el cartel DENTRO de este panel específico
            const vipBadge = panel.querySelector('.vip-badge');
            
            if (data.es_preferencial) {
                // Si es VIP: Mostramos cartel y ponemos números en rojo
                if(vipBadge) vipBadge.style.display = 'block';
                ticketNumberEl.style.color = '#dc3545'; // Rojo
                moduleNumberEl.style.color = '#dc3545';
            } else {
                // Si es Normal: Ocultamos cartel y usamos el color del servicio
                if(vipBadge) vipBadge.style.display = 'none';
                // Restauramos el color original del servicio
                ticketNumberEl.style.removeProperty('color'); 
                moduleNumberEl.style.removeProperty('color');
                // Aseguramos que se use la variable CSS del color
                ticketNumberEl.style.setProperty('--ticket-color', data.color_hex);
                moduleNumberEl.style.setProperty('--ticket-color', data.color_hex);
            }
            // ------------------------

            // Animación y sonido
            panel.classList.add('is-calling');
            setTimeout(() => panel.classList.remove('is-calling'), 1200);
            if (localStorage.getItem('pantallaTurnosIniciada')) {
                audio.play().catch(e => {
                    console.error("Error al reproducir sonido (bloqueo navegador):", e);
                    overlay.style.display = 'flex'; // Pedimos interacción nuevamente
                });
            }
        }

        // --- LÓGICA PARA LIMPIAR UN PANEL ESPECÍFICO ---
        function clearPanel(panel) {
            panel.classList.add('is-empty');
            panel.dataset.ticketId = "";

            panel.querySelector('.call-header').innerText = 'SISTEMA DE TURNOS';
            
            const ticketNumberEl = panel.querySelector('.ticket-number');
            ticketNumberEl.innerText = '----';
            ticketNumberEl.style.setProperty('--ticket-color', '#333');
            ticketNumberEl.style.removeProperty('color');

            const moduleNumberEl = panel.querySelector('.module-number');
            moduleNumberEl.innerText = '-';
            moduleNumberEl.style.setProperty('--ticket-color', '#333');
            ticketNumberEl.style.removeProperty('color');

            // Ocultar cartel VIP al limpiar
            const vipBadge = panel.querySelector('.vip-badge');
            if (vipBadge) vipBadge.style.display = 'none';
        }

        // --- LÓGICA PARA ACTUALIZAR EL HISTORIAL ---
        function updateHistory(historial) {
            const historyList = document.querySelector('.history-list');
            historyList.innerHTML = ''; // Limpiar la lista actual

            if (historial && historial.length > 0) {
                historial.forEach(ticket => {
                    const li = document.createElement('li');
                    li.className = 'fade-in';
                    li.innerHTML = `
                        <span class="history-ticket" style="--ticket-color: ${ticket.color_hex}">${ticket.numero_ticket.split('-')[1]}</span>
                        <span class="history-service">${ticket.modulo_solicitado}</span>
                        <span class="history-module">Módulo ${ticket.numero_meson}</span>
                    `;
                    historyList.appendChild(li);
                });
            } else {
                historyList.innerHTML = '<li class="no-history fade-in"><span>No hay llamados recientes.</span></li>';
            }
        }

        // --- LÓGICA PARA REACCIONAR A NUEVOS LLAMADOS ---
        socket.on('nuevo_llamado', function(data) {
            console.log('EVENTO: Nuevo llamado recibido:', data);
            
            const llamadoData = data.llamado;
            const historialData = data.historial;

            // --- AQUÍ ESTÁ EL FILTRO DE SEGURIDAD ---
            // Si el backend dice que no es visible, paramos aquí.
            // El código de abajo NI SE ENTERA de que llegó un aviso.
            if (llamadoData.visible === false) {
                return; 
            }
            // ----------------------------------------

            // Buscar si el ticket ya está siendo mostrado (para re-llamados)
            let existingPanel = callPanels.find(p => p.dataset.ticketId == llamadoData.id_ticket);

            if (existingPanel) {
                // Si ya existe, es un re-llamado. Solo lo animamos.
                existingPanel.classList.add('is-calling');
                setTimeout(() => existingPanel.classList.remove('is-calling'), 1200);
                 if (localStorage.getItem('pantallaTurnosIniciada')) {
                    audio.play().catch(e => {
                        console.error("Error al reproducir sonido (bloqueo navegador):", e);
                        overlay.style.display = 'flex'; // Pedimos interacción nuevamente
                    });
                }
            } else {
                // Si es un nuevo llamado, buscar un panel vacío
                let emptyPanel = callPanels.find(p => p.classList.contains('is-empty'));
                if (emptyPanel) {
                    updatePanel(emptyPanel, llamadoData);
                } else {
                    // Si no hay paneles vacíos, reemplazamos el más antiguo (el último en la lista)
                    const panelToReplace = callPanels[callPanels.length - 1];
                    updatePanel(panelToReplace, llamadoData);
                    // Movemos el panel actualizado al principio del contenedor para que visualmente sea el "más nuevo"
                    panelToReplace.parentElement.prepend(panelToReplace);
                    // Actualizamos la referencia del array de paneles
                    callPanels = Array.from(document.querySelectorAll('.call-panel-container .call-panel'));
                }
            }
            
            // Actualizar el historial dinámicamente
            if (historialData) {
                updateHistory(historialData);
            }
        });

        // --- LÓGICA PARA REACCIONAR A FINALIZACIÓN DE ATENCIÓN ---
        socket.on('atencion_finalizada', function(data) {
            console.log('EVENTO: Atención finalizada recibida:', data);
            
            const panelToClear = callPanels.find(p => p.dataset.ticketId == data.id_ticket);
            if (panelToClear) {
                clearPanel(panelToClear);
            }

            // Actualizar el historial dinámicamente
            if (data.historial) {
                updateHistory(data.historial);
            }
        });
    });
</script>
{% endblock %}
