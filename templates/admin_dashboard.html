{% extends 'base.html' %}
{% block title %}Dashboard - Admin{% endblock %}
{% block body_class %}form-body{% endblock %}
{% block content %}
{% include '_logged_in_header.html' %}
    <div class="admin-body">
        <style>
            .alert { padding: 15px; border-radius: 4px; margin-bottom: 10px; }
            .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
            .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        </style>
        <div class="admin-nav">
            <!-- Bot칩n Interruptor -->
            <form action="{{ url_for('toggle_sistema') }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                {% if sistema_abierto %}
                    <button type="submit" class="btn-danger">游댮 CERRAR SISTEMA (Nadie entra)</button>
                {% else %}
                    <button type="submit" class="btn-success">游릭 ABRIR SISTEMA</button>
                {% endif %}
            </form>
            <a href="{{ url_for('admin_dashboard') }}" class="nav-item active">Dashboard</a>
            <a href="{{ url_for('gestionar_usuarios') }}" class="nav-item">Gesti칩n de Usuarios</a>
            <a href="{{ url_for('gestionar_servicios') }}" class="nav-item">Gesti칩n de Servicios</a>
        </div>
        <div class="admin-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages" style="margin-bottom: 20px;">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            <div class="toolbar">
                <a href="{{ url_for('descargar_reporte_tickets') }}" class="btn-secondary">Descargar Reporte (CSV)</a>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Tickets Hoy</h3>
                    <p>{{ tickets_hoy }}</p>
                </div>
                <div class="stat-card">
                    <h3>En Espera</h3>
                    <p>{{ tickets_en_espera }}</p>
                </div>
                <div class="stat-card">
                    <h3>En Atenci칩n</h3>
                    <p>{{ tickets_en_atencion }}</p>
                </div>
                <div class="stat-card">
                    <h3>Atendidos Hoy</h3>
                    <p>{{ tickets_finalizados_hoy }}</p>
                </div>
                <div class="stat-card" style="border-left-color: #ffc107;">
                    <h3>T. Espera Prom.</h3>
                    <p>{{ promedio_espera }}</p>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="flujoPorHoraChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="ticketsPorServicioChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- GR츼FICO DE DONA ---
        try {
            const chartDataJSON_Dona = '{{ chart_data_dona|tojson|safe }}';
            const chartDataFromFlask_Dona = JSON.parse(chartDataJSON_Dona);
            const labels_dona = chartDataFromFlask_Dona.map(item => item[0]);
            const colors_dona = chartDataFromFlask_Dona.map(item => item[1]);
            const data_dona = chartDataFromFlask_Dona.map(item => item[2]);
            const ctx_dona = document.getElementById('ticketsPorServicioChart').getContext('2d');
            new Chart(ctx_dona, {
                type: 'doughnut',
                data: {
                    labels: labels_dona,
                    datasets: [{ label: 'Tickets por Servicio', data: data_dona, backgroundColor: colors_dona, borderColor: '#fff', borderWidth: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Distribuci칩n de Tickets por Servicio (Hist칩rico)' } } }
            });
        } catch (e) {
            console.error("Error al crear gr치fico de Dona:", e);
        }

        // --- GR츼FICO DE L칈NEAS (VERSI칍N SIMPLIFICADA PARA DEPURACI칍N) ---
        try {
            const dataLineasJSON = '{{ chart_data_lineas|tojson|safe }}';
            const dataLineas = JSON.parse(dataLineasJSON);

            const labelsLineas = Object.keys(dataLineas).sort();
            const dataLineasSorted = labelsLineas.map(key => dataLineas[key]);

            const ctxLine = document.getElementById('flujoPorHoraChart').getContext('2d');
            new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labelsLineas,
                    datasets: [{
                        label: 'Tickets por Hora (Hoy)',
                        data: dataLineasSorted,
                        borderColor: 'rgba(0, 48, 130, 1)',
                        backgroundColor: 'rgba(0, 48, 130, 0.1)', /* Color de relleno sugerido */
                        borderWidth: 2,
                        fill: true, /* Rellena el 치rea bajo la l칤nea */
                        tension: 0.1 /* Suaviza la l칤nea */
                    }]
                },
                /* --- A칌ADE ESTE BLOQUE DE OPCIONES --- */
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // 춰Esta es la opci칩n clave!
                    plugins: {
                        legend: {
                            display: false // Oculta la leyenda para un look m치s limpio si solo hay una l칤nea
                        },
                        title: {
                            display: true,
                            text: 'Flujo de Tickets por Hora (Hoy)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (e) {
            console.error("Error al crear gr치fico de L칤neas:", e);
        }
    });
</script>
{% endblock %}